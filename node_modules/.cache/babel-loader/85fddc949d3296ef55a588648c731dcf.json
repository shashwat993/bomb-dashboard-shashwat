{"ast":null,"code":"import EventEmitter from \"eventemitter3\";\nimport WalletConnect from \"@walletconnect/client\";\nimport QRCodeModal from \"@walletconnect/qrcode-modal\";\nimport { IJsonRpcConnection } from \"@walletconnect/jsonrpc-types\";\nimport { formatJsonRpcError } from \"@walletconnect/jsonrpc-utils\";\nexport class SignerConnection extends IJsonRpcConnection {\n  constructor(opts) {\n    super();\n    this.events = new EventEmitter();\n    this.accounts = [];\n    this.chainId = 1;\n    this.pending = false;\n    this.bridge = \"https://bridge.walletconnect.org\";\n    this.qrcode = true;\n    this.qrcodeModalOptions = undefined;\n    this.opts = opts;\n    this.chainId = (opts === null || opts === void 0 ? void 0 : opts.chainId) || this.chainId;\n    this.wc = this.register(opts);\n  }\n\n  get connected() {\n    return typeof this.wc !== \"undefined\" && this.wc.connected;\n  }\n\n  get connecting() {\n    return this.pending;\n  }\n\n  get connector() {\n    this.wc = this.register(this.opts);\n    return this.wc;\n  }\n\n  on(event, listener) {\n    this.events.on(event, listener);\n  }\n\n  once(event, listener) {\n    this.events.once(event, listener);\n  }\n\n  off(event, listener) {\n    this.events.off(event, listener);\n  }\n\n  removeListener(event, listener) {\n    this.events.removeListener(event, listener);\n  }\n\n  async open(chainId) {\n    if (this.connected) {\n      this.onOpen();\n      return;\n    }\n\n    return new Promise((resolve, reject) => {\n      this.on(\"error\", err => {\n        reject(err);\n      });\n      this.on(\"open\", () => {\n        resolve();\n      });\n      this.create(chainId);\n    });\n  }\n\n  async close() {\n    if (typeof this.wc === \"undefined\") return;\n\n    if (this.wc.connected) {\n      this.wc.killSession();\n    }\n\n    this.onClose();\n  }\n\n  async send(payload) {\n    this.wc = this.register(this.opts);\n    if (!this.connected) await this.open();\n    this.sendPayload(payload).then(res => this.events.emit(\"payload\", res)).catch(e => this.events.emit(\"payload\", formatJsonRpcError(payload.id, e.message)));\n  }\n\n  register(opts) {\n    if (this.wc) return this.wc;\n    this.opts = opts || this.opts;\n    this.bridge = (opts === null || opts === void 0 ? void 0 : opts.connector) ? opts.connector.bridge : (opts === null || opts === void 0 ? void 0 : opts.bridge) || \"https://bridge.walletconnect.org\";\n    this.qrcode = typeof (opts === null || opts === void 0 ? void 0 : opts.qrcode) === \"undefined\" || opts.qrcode !== false;\n    this.chainId = typeof (opts === null || opts === void 0 ? void 0 : opts.chainId) !== \"undefined\" ? opts.chainId : this.chainId;\n    this.qrcodeModalOptions = opts === null || opts === void 0 ? void 0 : opts.qrcodeModalOptions;\n    const connectorOpts = {\n      bridge: this.bridge,\n      qrcodeModal: this.qrcode ? QRCodeModal : undefined,\n      qrcodeModalOptions: this.qrcodeModalOptions,\n      storageId: opts === null || opts === void 0 ? void 0 : opts.storageId,\n      signingMethods: opts === null || opts === void 0 ? void 0 : opts.signingMethods,\n      clientMeta: opts === null || opts === void 0 ? void 0 : opts.clientMeta\n    };\n    this.wc = typeof (opts === null || opts === void 0 ? void 0 : opts.connector) !== \"undefined\" ? opts.connector : new WalletConnect(connectorOpts);\n\n    if (typeof this.wc === \"undefined\") {\n      throw new Error(\"Failed to register WalletConnect connector\");\n    }\n\n    if (this.wc.accounts.length) {\n      this.accounts = this.wc.accounts;\n    }\n\n    if (this.wc.chainId) {\n      this.chainId = this.wc.chainId;\n    }\n\n    this.registerConnectorEvents();\n    return this.wc;\n  }\n\n  onOpen(wc) {\n    this.pending = false;\n\n    if (wc) {\n      this.wc = wc;\n    }\n\n    this.events.emit(\"open\");\n  }\n\n  onClose() {\n    this.pending = false;\n\n    if (this.wc) {\n      this.wc = undefined;\n    }\n\n    this.events.emit(\"close\");\n  }\n\n  onError(payload) {\n    let message = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : \"Failed or Rejected Request\";\n    let code = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : -32000;\n    const errorPayload = {\n      id: payload.id,\n      jsonrpc: payload.jsonrpc,\n      error: {\n        code,\n        message\n      }\n    };\n    this.events.emit(\"payload\", errorPayload);\n    return errorPayload;\n  }\n\n  create(chainId) {\n    this.wc = this.register(this.opts);\n    this.chainId = chainId || this.chainId;\n    if (this.connected || this.pending) return;\n    this.pending = true;\n    this.registerConnectorEvents();\n    this.wc.createSession({\n      chainId: this.chainId\n    }).then(() => this.events.emit(\"created\")).catch(e => this.events.emit(\"error\", e));\n  }\n\n  registerConnectorEvents() {\n    this.wc = this.register(this.opts);\n    this.wc.on(\"connect\", err => {\n      var _a, _b;\n\n      if (err) {\n        this.events.emit(\"error\", err);\n        return;\n      }\n\n      this.accounts = ((_a = this.wc) === null || _a === void 0 ? void 0 : _a.accounts) || [];\n      this.chainId = ((_b = this.wc) === null || _b === void 0 ? void 0 : _b.chainId) || this.chainId;\n      this.onOpen();\n    });\n    this.wc.on(\"disconnect\", err => {\n      if (err) {\n        this.events.emit(\"error\", err);\n        return;\n      }\n\n      this.onClose();\n    });\n    this.wc.on(\"modal_closed\", () => {\n      this.events.emit(\"error\", new Error(\"User closed modal\"));\n    });\n    this.wc.on(\"session_update\", (error, payload) => {\n      const {\n        accounts,\n        chainId\n      } = payload.params[0];\n\n      if (!this.accounts || accounts && this.accounts !== accounts) {\n        this.accounts = accounts;\n        this.events.emit(\"accountsChanged\", accounts);\n      }\n\n      if (!this.chainId || chainId && this.chainId !== chainId) {\n        this.chainId = chainId;\n        this.events.emit(\"chainChanged\", chainId);\n      }\n    });\n  }\n\n  async sendPayload(payload) {\n    this.wc = this.register(this.opts);\n\n    try {\n      const response = await this.wc.unsafeSend(payload);\n      return this.sanitizeResponse(response);\n    } catch (error) {\n      return this.onError(payload, error.message);\n    }\n  }\n\n  sanitizeResponse(response) {\n    return typeof response.error !== \"undefined\" && typeof response.error.code === \"undefined\" ? formatJsonRpcError(response.id, response.error.message) : response;\n  }\n\n}\nexport default SignerConnection;","map":{"version":3,"sources":["../../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import EventEmitter from \"eventemitter3\";\nimport WalletConnect from \"@walletconnect/client\";\nimport QRCodeModal from \"@walletconnect/qrcode-modal\";\nimport { IJsonRpcConnection } from \"@walletconnect/jsonrpc-types\";\nimport { formatJsonRpcError } from \"@walletconnect/jsonrpc-utils\";\nexport class SignerConnection extends IJsonRpcConnection {\n    constructor(opts) {\n        super();\n        this.events = new EventEmitter();\n        this.accounts = [];\n        this.chainId = 1;\n        this.pending = false;\n        this.bridge = \"https://bridge.walletconnect.org\";\n        this.qrcode = true;\n        this.qrcodeModalOptions = undefined;\n        this.opts = opts;\n        this.chainId = (opts === null || opts === void 0 ? void 0 : opts.chainId) || this.chainId;\n        this.wc = this.register(opts);\n    }\n    get connected() {\n        return typeof this.wc !== \"undefined\" && this.wc.connected;\n    }\n    get connecting() {\n        return this.pending;\n    }\n    get connector() {\n        this.wc = this.register(this.opts);\n        return this.wc;\n    }\n    on(event, listener) {\n        this.events.on(event, listener);\n    }\n    once(event, listener) {\n        this.events.once(event, listener);\n    }\n    off(event, listener) {\n        this.events.off(event, listener);\n    }\n    removeListener(event, listener) {\n        this.events.removeListener(event, listener);\n    }\n    async open(chainId) {\n        if (this.connected) {\n            this.onOpen();\n            return;\n        }\n        return new Promise((resolve, reject) => {\n            this.on(\"error\", err => {\n                reject(err);\n            });\n            this.on(\"open\", () => {\n                resolve();\n            });\n            this.create(chainId);\n        });\n    }\n    async close() {\n        if (typeof this.wc === \"undefined\")\n            return;\n        if (this.wc.connected) {\n            this.wc.killSession();\n        }\n        this.onClose();\n    }\n    async send(payload) {\n        this.wc = this.register(this.opts);\n        if (!this.connected)\n            await this.open();\n        this.sendPayload(payload)\n            .then((res) => this.events.emit(\"payload\", res))\n            .catch(e => this.events.emit(\"payload\", formatJsonRpcError(payload.id, e.message)));\n    }\n    register(opts) {\n        if (this.wc)\n            return this.wc;\n        this.opts = opts || this.opts;\n        this.bridge = (opts === null || opts === void 0 ? void 0 : opts.connector)\n            ? opts.connector.bridge\n            : (opts === null || opts === void 0 ? void 0 : opts.bridge) || \"https://bridge.walletconnect.org\";\n        this.qrcode = typeof (opts === null || opts === void 0 ? void 0 : opts.qrcode) === \"undefined\" || opts.qrcode !== false;\n        this.chainId = typeof (opts === null || opts === void 0 ? void 0 : opts.chainId) !== \"undefined\" ? opts.chainId : this.chainId;\n        this.qrcodeModalOptions = opts === null || opts === void 0 ? void 0 : opts.qrcodeModalOptions;\n        const connectorOpts = {\n            bridge: this.bridge,\n            qrcodeModal: this.qrcode ? QRCodeModal : undefined,\n            qrcodeModalOptions: this.qrcodeModalOptions,\n            storageId: opts === null || opts === void 0 ? void 0 : opts.storageId,\n            signingMethods: opts === null || opts === void 0 ? void 0 : opts.signingMethods,\n            clientMeta: opts === null || opts === void 0 ? void 0 : opts.clientMeta,\n        };\n        this.wc =\n            typeof (opts === null || opts === void 0 ? void 0 : opts.connector) !== \"undefined\" ? opts.connector : new WalletConnect(connectorOpts);\n        if (typeof this.wc === \"undefined\") {\n            throw new Error(\"Failed to register WalletConnect connector\");\n        }\n        if (this.wc.accounts.length) {\n            this.accounts = this.wc.accounts;\n        }\n        if (this.wc.chainId) {\n            this.chainId = this.wc.chainId;\n        }\n        this.registerConnectorEvents();\n        return this.wc;\n    }\n    onOpen(wc) {\n        this.pending = false;\n        if (wc) {\n            this.wc = wc;\n        }\n        this.events.emit(\"open\");\n    }\n    onClose() {\n        this.pending = false;\n        if (this.wc) {\n            this.wc = undefined;\n        }\n        this.events.emit(\"close\");\n    }\n    onError(payload, message = \"Failed or Rejected Request\", code = -32000) {\n        const errorPayload = {\n            id: payload.id,\n            jsonrpc: payload.jsonrpc,\n            error: { code, message },\n        };\n        this.events.emit(\"payload\", errorPayload);\n        return errorPayload;\n    }\n    create(chainId) {\n        this.wc = this.register(this.opts);\n        this.chainId = chainId || this.chainId;\n        if (this.connected || this.pending)\n            return;\n        this.pending = true;\n        this.registerConnectorEvents();\n        this.wc\n            .createSession({ chainId: this.chainId })\n            .then(() => this.events.emit(\"created\"))\n            .catch((e) => this.events.emit(\"error\", e));\n    }\n    registerConnectorEvents() {\n        this.wc = this.register(this.opts);\n        this.wc.on(\"connect\", (err) => {\n            var _a, _b;\n            if (err) {\n                this.events.emit(\"error\", err);\n                return;\n            }\n            this.accounts = ((_a = this.wc) === null || _a === void 0 ? void 0 : _a.accounts) || [];\n            this.chainId = ((_b = this.wc) === null || _b === void 0 ? void 0 : _b.chainId) || this.chainId;\n            this.onOpen();\n        });\n        this.wc.on(\"disconnect\", (err) => {\n            if (err) {\n                this.events.emit(\"error\", err);\n                return;\n            }\n            this.onClose();\n        });\n        this.wc.on(\"modal_closed\", () => {\n            this.events.emit(\"error\", new Error(\"User closed modal\"));\n        });\n        this.wc.on(\"session_update\", (error, payload) => {\n            const { accounts, chainId } = payload.params[0];\n            if (!this.accounts || (accounts && this.accounts !== accounts)) {\n                this.accounts = accounts;\n                this.events.emit(\"accountsChanged\", accounts);\n            }\n            if (!this.chainId || (chainId && this.chainId !== chainId)) {\n                this.chainId = chainId;\n                this.events.emit(\"chainChanged\", chainId);\n            }\n        });\n    }\n    async sendPayload(payload) {\n        this.wc = this.register(this.opts);\n        try {\n            const response = await this.wc.unsafeSend(payload);\n            return this.sanitizeResponse(response);\n        }\n        catch (error) {\n            return this.onError(payload, error.message);\n        }\n    }\n    sanitizeResponse(response) {\n        return typeof response.error !== \"undefined\" &&\n            typeof response.error.code === \"undefined\"\n            ? formatJsonRpcError(response.id, response.error.message)\n            : response;\n    }\n}\nexport default SignerConnection;\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}